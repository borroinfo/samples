pico-8 cartridge // http://www.pico-8.com
version 18
__lua__

--zu erklaeren: finite state maschine
-- 1. elemente und level zeichnen
-- 2. flag fuer boden setzen
-- 3. programmieren

--erweiterungen: levelbegrenzung, win state 


function _init()
	px = 100 -- x position
	py = 80 -- y position
	pstate=0 --current player state
	pspr=0  --current sprite
	pdir=0 -- current direction
	pat=0 --player state timer
end

function _draw()
	cls()
	
	--draw the world
	map(0,0,0,0,16,16)
	
	--draw the player, we use dir to mirror sprites
	spr(pspr,px,py,1,1,pdir==-1)
end

function canfall()
	--get the map tile under the player
	v=mget(flr((px+4)/8),flr((py+8)/8))
	
	--see if it's flagged as wall
	return not fget (v,0)
end

function change_state(s)
	pstate = s
	pat = 0 
end


function _update()
	b0 = btn(0) --button 0 state	
	b1 = btn(1) --button 1 state
	b2 = btn(2) --button 2 state
	
	px = (px + 128)%128 -- no bounds left and right
	pat += 1 --increment state clock
	
	--idle state
	if pstate == 0 then
		pspr = 0
		if(b0 or b1) change_state(1)
		if(b2) change_state(3)
		if(canfall()) change_state(2)
	end
	
	--walk state
	if pstate == 1 then
		if(b0) pdir =- 1
		if(b1) pdir = 1
		px += pdir * min(pat,2)
		pspr = flr(pat/2)%2
		
		if(not (b0 or b1)) change_state(0)
		if(b2) change_state(3)
		if(canfall())change_state(2)
	end
	
	--fall state
	if pstate == 2 then
		pspr = 2
		if(canfall())then
			if(b0) px-= 1 --steer left
			if(b1) px+= 1 --steer right
			py+=min(4,pat) --move the player
			if(not canfall()) py= flr(py/8)*8 --check ground contact
		else
			py=flr(py/8)*8 --fix position when we hit ground
			change_state(0)
		end
	end
	
	--jump state
	if pstate == 3 then
		pspr = 2
		py-=6-pat
		if(b0)px -=2
		if(b1)px+=2
		if(not b2 or pat>7)change_state(0)
	end

end				
	
__gfx__
004440000044400000444000cccccccccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
004f6000004f6000004f6000cccccccccccc77cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
004ff000004ff000004ff000ccccccccccc7777c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0003b0000003b0000003b000cccccccccc7777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000333000003330000033300ccccccccc71777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000110000001100000011000ccccccccc77111770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000110000001144000441000cccccccccc77777c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
004444000044040000004400cccccccccccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333333333333300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333c33333333333333c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444cc444444444444cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444ccc4444444444ccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444cccc44444444cccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444ccccc444444ccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444cccccc4444cccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222ccccccc44ccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0303030303030303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303111010120303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303111203030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1110101203030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0311101010120303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303111010101203111203030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030311101010030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030311101010101203031110101012030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1110101203030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
